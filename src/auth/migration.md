# FreeIPA账号迁移

实验室手动给同学们分配账号由来已久，各台服务器上都有大量的本地账号存在。

本文档意图指导大家在尽量不影响实验的情况下，将账号迁移至FreeIPA中。

迁移完成后将可以使用[分布式存储](../storage/README.md)

## 计划

迁移将以灰度方式逐渐完成。在迁移过程中，将一部分服务器接入FreeIPA，未接入的服务器则按原有方式登录。根据操作的进度和大家的反馈，逐步增加接入服务器的数量。

对之前在已接入的服务器中的任意一台上拥有账号的同学，Infra团队会为你分配FreeIPA账号，并主动联系你告知初始密码。若你认为你应该收到却未收到初始密码，请联系Infra团队。

## 需要的操作

收到密码的同学可使用FreeIPA账号登录任何已接入的服务器，也可以使用你原有的登录方式登录原来有账号的服务器。请在合适的时候，使用迁移脚本清除本地账号，完全接入FreeIPA：
```bash
sudo ipa-migrate
```
此过程根据你home目录中文件数量，可能需要几秒到几十分钟的时间（chown所需时间）。

迁移后：
* 你的所有文件将会保留。
* 你将不能使用原有密码登录，必需使用FreeIPA的密码。
* 你依然可以使用原来的公钥登录，同时你也可以使用FreeIPA中[录入](self-service.md#添加ssh公钥)的公钥。
* 你的uid、gid将更新。
* 你的home目录的权限将自动更新。若在home目录外还有你所有的文件，请联系管理员更新权限。

需要注意：
* 每台服务器均可独立迁移，你可根据自己的实际情况控制迁移进度。若暂不进行迁移应该不会影响正常操作。
* 在运行迁移脚本前，请结束在该主机上，除正在操作的shell外的所有进程。

再次登录后，运行`id`命令确认是否迁移成功。若显示uid为8596XXXXX则表示已经迁移成功，否则请联系Infra团队。

## FAQ

* 账户迁移和分布式存储有什么关系？

  迁移后才有权限在分布式存储中创建文件。但你的文件依然会保留在原来的位置，并不会自动迁移到分布式存储上。如有需要，可以自行将数据复制到`/mnt/cephfs`中
